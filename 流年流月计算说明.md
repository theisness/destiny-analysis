# 流年流月计算说明

## 📋 概述

本系统的流年流月采用**前端实时计算**方式，不依赖后端存储历史数据。用户可以查看任意年份的流年流月信息。

## 🔢 流年计算

### 原理：六十甲子

流年基于**六十甲子**纪年法计算：

```
天干（10个）：甲、乙、丙、丁、戊、己、庚、辛、壬、癸
地支（12个）：子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥

六十甲子 = 天干 × 地支 = 10 × 12 的组合
从"甲子"开始，到"癸亥"结束，共60个组合
```

### 计算公式

```javascript
// 计算某年的天干地支
const ganIndex = (year - 4) % 10;
const zhiIndex = (year - 4) % 12;

const gan = TIAN_GAN[ganIndex];  // 天干
const zhi = DI_ZHI[zhiIndex];    // 地支
```

### 为什么是 `year - 4`？

因为公元4年是**甲子年**（六十甲子的起点），所以：
- 公元4年：甲子
- 公元5年：乙丑
- 公元6年：丙寅
- ...

### 示例

| 年份 | 计算 | 天干索引 | 地支索引 | 结果 |
|------|------|---------|---------|------|
| 2024 | (2024-4)%10=0, (2024-4)%12=0 | 0(甲) | 0(子) | 甲子 |
| 2025 | (2025-4)%10=1, (2025-4)%12=1 | 1(乙) | 1(丑) | 乙丑 |
| 2026 | (2026-4)%10=2, (2026-4)%12=2 | 2(丙) | 2(寅) | 丙寅 |

## 📅 流月计算

### 原理：五虎遁月诀

流月基于**五虎遁月诀**计算，根据年份的天干确定正月的天干：

```
甲己之年丙作首 - 甲年、己年正月从丙寅起
乙庚之岁戊为头 - 乙年、庚年正月从戊寅起
丙辛必定寻庚起 - 丙年、辛年正月从庚寅起
丁壬壬位顺行流 - 丁年、壬年正月从壬寅起
戊癸甲寅好追求 - 戊年、癸年正月从甲寅起
```

### 计算步骤

1. **确定年份天干**
   ```javascript
   const yearGanIndex = (year - 4) % 10;
   ```

2. **查找正月天干**
   ```javascript
   const firstMonthGanMap = {
     0: 2, 5: 2,  // 甲(0)、己(5)年从丙(2)起
     1: 4, 6: 4,  // 乙(1)、庚(6)年从戊(4)起
     2: 6, 7: 6,  // 丙(2)、辛(7)年从庚(6)起
     3: 8, 8: 8,  // 丁(3)、壬(8)年从壬(8)起
     4: 0, 9: 0   // 戊(4)、癸(9)年从甲(0)起
   };
   
   let monthGanIndex = firstMonthGanMap[yearGanIndex];
   ```

3. **计算每月干支**
   ```javascript
   for (let month = 1; month <= 12; month++) {
     const gan = TIAN_GAN[monthGanIndex % 10];
     const zhi = DI_ZHI[(month + 1) % 12];  // 正月为寅(2)
     
     monthGanIndex++;  // 天干依次递增
   }
   ```

### 示例：2024年（甲辰年）

| 月份 | 地支 | 天干计算 | 结果 |
|------|------|---------|------|
| 1月 | 寅 | 甲年从丙起 | 丙寅 |
| 2月 | 卯 | 丙+1=丁 | 丁卯 |
| 3月 | 辰 | 丁+1=戊 | 戊辰 |
| 4月 | 巳 | 戊+1=己 | 己巳 |
| 5月 | 午 | 己+1=庚 | 庚午 |
| 6月 | 未 | 庚+1=辛 | 辛未 |
| 7月 | 申 | 辛+1=壬 | 壬申 |
| 8月 | 酉 | 壬+1=癸 | 癸酉 |
| 9月 | 戌 | 癸+1=甲 | 甲戌 |
| 10月 | 亥 | 甲+1=乙 | 乙亥 |
| 11月 | 子 | 乙+1=丙 | 丙子 |
| 12月 | 丑 | 丙+1=丁 | 丁丑 |

## 💻 前端实现

### 流年计算函数

```javascript
const calculateLiunian = (centerYear) => {
  const liunian = [];
  const startYear = centerYear - 5;  // 前5年
  
  for (let i = 0; i < 11; i++) {  // 共11年（前5+当前+后5）
    const year = startYear + i;
    const ganIndex = (year - 4) % 10;
    const zhiIndex = (year - 4) % 12;
    
    liunian.push({
      year: year,
      gan: TIAN_GAN[ganIndex],
      zhi: DI_ZHI[zhiIndex],
      isCurrent: year === new Date().getFullYear()
    });
  }
  
  return liunian;
};
```

### 流月计算函数

```javascript
const calculateLiuyue = (year) => {
  const liuyue = [];
  const yearGanIndex = (year - 4) % 10;
  
  // 五虎遁月诀映射
  const firstMonthGanMap = {
    0: 2, 5: 2,  // 甲、己
    1: 4, 6: 4,  // 乙、庚
    2: 6, 7: 6,  // 丙、辛
    3: 8, 8: 8,  // 丁、壬
    4: 0, 9: 0   // 戊、癸
  };
  
  let monthGanIndex = firstMonthGanMap[yearGanIndex];
  const currentMonth = new Date().getMonth() + 1;
  
  for (let month = 1; month <= 12; month++) {
    liuyue.push({
      month: month,
      gan: TIAN_GAN[monthGanIndex % 10],
      zhi: DI_ZHI[(month + 1) % 12],
      isCurrent: year === new Date().getFullYear() && month === currentMonth
    });
    monthGanIndex++;
  }
  
  return liuyue;
};
```

## 🎨 用户界面功能

### 1. 年份选择器

- **下拉选择** - 可选择前后50年范围内的任意年份
- **左右箭头** - 快速切换±10年
- **今年按钮** - 一键返回当前年份

### 2. 当前标记

- **当前年份** - 以黄色渐变背景高亮
- **当前月份** - 以黄色渐变背景高亮（**基于农历月份判断**）
- **当前大运** - 以红色渐变背景高亮

### 3. 农历月份判断 ⭐

**重要**：流月的当前标记使用**农历月份**而非阳历月份！

系统通过以下方式实现：
1. 页面加载时调用 `baziAPI.getCurrentLunar()` API
2. 自动携带JWT token进行认证
3. 获取当前准确的农历年、月、日信息
4. 使用农历月份来判断并高亮当前流月
5. 在流月提示框显示当前农历信息

**前端调用代码**：
```javascript
// 使用baziAPI统一管理，自动带token
const fetchCurrentLunar = async () => {
  try {
    const response = await baziAPI.getCurrentLunar();
    setCurrentLunarInfo(response.data.data);
  } catch (error) {
    console.error('获取当前农历信息失败:', error);
  }
};
```

**API 示例响应**：
```json
{
  "success": true,
  "data": {
    "year": 2024,
    "month": 9,
    "day": 9,
    "isLeapMonth": false,
    "yearInGanZhi": "甲辰",
    "monthInGanZhi": "癸酉"
  }
}
```

### 4. 实时更新

- 选择年份后，流年和流月立即重新计算
- 无需等待后端响应，体验流畅

## 📊 大运显示优化

### 起运时间展示

```
🕐 起运时间
2岁 3个月 15天
（约2026年起运）
```

### 当前大运识别

```javascript
// 计算当前年龄
const birthYear = record.gregorianDate?.year || 0;
const currentAge = currentYear - birthYear;

// 判断是否是当前大运
const isCurrent = currentAge >= yun.age && 
  (index === dayunList.length - 1 || currentAge < dayunList[index + 1]?.age);
```

### 视觉效果

- **普通大运** - 紫色渐变背景
- **当前大运** - 红色渐变背景 + 放大效果
- **"当前"徽章** - 红色圆角标签

## 🔧 技术优势

1. **无需后端存储** - 减少数据库压力
2. **实时计算** - 可查看任意年份
3. **响应迅速** - 纯前端计算，无网络延迟
4. **准确可靠** - 基于标准算法
5. **易于维护** - 算法清晰，便于调试

## 📚 参考资料

- [六十甲子 - 维基百科](https://zh.wikipedia.org/wiki/六十甲子)
- [五虎遁月诀 - 百度百科](https://baike.baidu.com/item/五虎遁月诀)
- [干支纪年法](https://zh.wikipedia.org/wiki/干支纪年)

## 🔗 相关文件

- `frontend/src/pages/BaziDetail/BaziDetail.js` - 计算逻辑实现
- `frontend/src/pages/BaziDetail/BaziDetail.css` - 样式定义
- `backend/utils/bazi-calculator.js` - 后端算法参考

