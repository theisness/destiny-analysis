# 更新日志

## 🎉 v1.3.0 - 流年流月实时计算与大运优化（最新）

### 📅 更新日期
2024年最新版本

### ✨ 新功能

#### 0. 四柱输入支持大运计算
当用户通过四柱选择对应日期后，系统会：

- ✅ **自动计算大运** - 与公历输入相同的计算方式
- ✅ **计算起运时间** - 显示准确的起运年龄和日期
- ✅ **智能判断** - 如果未选择日期，大运显示为空（不影响其他功能）
- ✅ **数据一致性** - 四柱输入与日期输入得到相同的大运结果

#### 1. 流年流月前端实时计算
不再依赖后端存储的历史数据，改为前端动态计算：

- ✅ **年份选择器** - 可以查看任意年份的流年
- ✅ **实时计算** - 基于六十甲子和五虎遁月诀计算
- ✅ **当前标记** - 自动高亮当前年份和月份
- ✅ **农历月份判断** - 流月高亮使用农历而非阳历
- ✅ **前后浏览** - 支持快速切换到其他年份

#### 2. 大运信息优化显示
增强大运和起运时间的展示：

- ✅ **起运信息框** - 独立美观的起运时间展示
- ✅ **起运年份** - 自动计算具体起运的公历年份
- ✅ **当前大运** - 自动识别并高亮当前所处大运
- ✅ **视觉优化** - 改进配色和布局

#### 3. 用户体验提升
- ✅ **交互式年份控制** - 左右箭头快速切换年份
- ✅ **回到今年** - 一键返回当前年份
- ✅ **五虎遁月诀提示** - 显示流月计算口诀
- ✅ **响应式设计** - 完美支持移动端

### 📝 更新的文件

#### 前端
- **frontend/src/api/api.js**
  - 新增 `baziAPI.getCurrentLunar()` 方法
  - 统一管理API调用，自动带token

- **frontend/src/pages/BaziDetail/BaziDetail.js**
  - 添加 `calculateLiunian` 函数实时计算流年
  - 添加 `calculateLiuyue` 函数实时计算流月（五虎遁月诀）
  - 添加年份选择器和导航控件
  - 优化大运显示，自动标记当前大运
  - 添加当前年份/月份的高亮显示
  - 使用 `baziAPI.getCurrentLunar()` 获取当前农历信息
  - 使用农历月份判断当前流月（而非阳历）

- **frontend/src/pages/BaziDetail/BaziDetail.css**
  - 新增 `.qiyun-info-box` 起运信息框样式
  - 新增 `.current-badge` 当前标记样式
  - 新增 `.year-selector` 年份选择器样式
  - 新增 `.liuyue-hint` 流月口诀提示样式
  - 新增 `.current-lunar-info` 当前农历信息样式
  - 优化移动端适配

#### 后端
- **backend/utils/bazi-calculator.js**
  - 修改 `calculateFromSizhu` 函数，添加可选的 `dateTime` 参数
  - 当提供日期时，自动计算大运和起运时间
  - 与 `calculateBazi` 使用相同的大运计算逻辑

- **backend/routes/bazi.js**
  - 新增 `GET /api/bazi/current-lunar` 端点
  - 返回当前准确的农历年月日信息
  - 包含年月干支信息
  - 四柱输入时，传递日期信息给 `calculateFromSizhu`

### 🎯 技术实现

#### 四柱输入计算大运
```javascript
// backend/utils/bazi-calculator.js
const calculateFromSizhu = (
  yearGanZhi, monthGanZhi, dayGanZhi, hourGanZhi, 
  gender, 
  dateTime = null  // 可选的日期时间参数
) => {
  // ...基础计算
  
  // 如果提供了日期，计算大运和起运
  let dayun = [];
  let qiyunAge = { years: 0, months: 0, days: 0 };
  
  if (dateTime && dateTime.year) {
    const solar = Solar.fromYmdHms(
      dateTime.year, dateTime.month, dateTime.day, 
      dateTime.hour, dateTime.minute, 0
    );
    const lunar = solar.getLunar();
    const bazi = lunar.getEightChar();
    
    dayun = calculateDayun(bazi, gender, lunar);
    qiyunAge = calculateQiyunAge(bazi, gender);
  }
  
  return { /* 包含大运和起运信息 */ };
};
```

#### 后端路由处理
```javascript
// backend/routes/bazi.js
if (inputType === 'sizhu') {
  let dateTimeForDayun = null;
  
  // 如果前端提供了日期，用于计算大运
  if (gregorianDate && gregorianDate.year) {
    dateTimeForDayun = {
      year: gregorianDate.year,
      month: gregorianDate.month,
      day: gregorianDate.day,
      hour: gregorianDate.hour || 0,
      minute: gregorianDate.minute || 0
    };
  }
  
  // 计算八字（包含大运）
  baziResult = calculateFromSizhu(
    sizhu.year, sizhu.month, sizhu.day, sizhu.hour,
    gender,
    dateTimeForDayun
  );
}
```

#### 流年计算（六十甲子）
```javascript
const calculateLiunian = (centerYear) => {
  const ganIndex = (year - 4) % 10;
  const zhiIndex = (year - 4) % 12;
  return {
    year,
    gan: TIAN_GAN[ganIndex],
    zhi: DI_ZHI[zhiIndex],
    isCurrent: year === currentYear
  };
};
```

#### 流月计算（五虎遁月诀）
```javascript
// 甲己之年丙作首，乙庚之岁戊为头
// 丙辛必定寻庚起，丁壬壬位顺行流
// 戊癸甲寅好追求
const calculateLiuyue = (year) => {
  const yearGanIndex = (year - 4) % 10;
  const firstMonthGanMap = {
    0: 2, 5: 2,  // 甲、己年从丙起
    1: 4, 6: 4,  // 乙、庚年从戊起
    2: 6, 7: 6,  // 丙、辛年从庚起
    3: 8, 8: 8,  // 丁、壬年从壬起
    4: 0, 9: 0   // 戊、癸年从甲起
  };
  // ...
};
```

### 💡 使用说明

#### 查看流年
1. 打开八字详情页
2. 使用年份选择器选择想查看的年份
3. 点击左右箭头快速翻页（每次10年）
4. 点击"今年"按钮回到当前年份
5. 当前年份会以黄色高亮显示

#### 查看流月
1. 流月会根据选择的年份自动更新
2. 当前月份以黄色高亮显示（**基于农历月份**）
3. 流月提示框显示当前农历月份和干支
4. 参考五虎遁月诀口诀理解计算规律

#### 农历月份判断
- 系统自动调用后端API获取当前准确的农历信息
- 流月高亮基于农历月份，而非阳历月份
- 在查看当前年份时，提示框会显示：`（当前：农历X月 - 干支）`

#### 查看大运
1. 起运时间会在顶部独立显示
2. 当前大运以红色高亮显示
3. 每个大运显示起始年龄和年份

---

## 🎉 v1.2.0 - 四柱反推日期算法修复

### 📅 更新日期
2024年

### 🐛 问题修复

#### 干支计算算法错误
- ❌ **旧方法**: 使用错误的地支12天轮回算法
- ✅ **新方法**: 使用正确的六十甲子（60天轮回）算法

#### 实现方式

**后端 API**（首选）：
- 创建新的 `/api/bazi/reverse-calculate` 端点
- 使用 `lunar-javascript` 库精确遍历日期
- 完全匹配年柱、月柱、日柱、时柱
- 返回精确的公历和农历日期

**前端降级计算**：
- 优先调用后端 API
- 如果后端不可用，使用前端六十甲子算法
- 基于1900年1月1日基准日（甲戌日）
- 通过天数差计算干支序号

### 📝 更新的文件

#### 后端
- **backend/routes/bazi.js**
  - 新增 `POST /api/bazi/reverse-calculate` 端点
  - 遍历60-80年日期范围
  - 精确匹配四柱组合

#### 前端
- **frontend/src/pages/BaziInput/BaziInput.js**
  - 修正 `calculatePossibleDates` 函数
  - 实现六十甲子算法
  - 添加后端 API 调用
  - 添加降级到本地计算的逻辑

### 🔧 技术细节

#### 六十甲子原理
```
天干（10个）：甲、乙、丙、丁、戊、己、庚、辛、壬、癸
地支（12个）：子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥

组合规律：
- 最小公倍数：LCM(10, 12) = 60
- 日柱60天一个完整循环
- 从"甲子"开始，到"癸亥"结束
```

#### 计算公式
```javascript
// 基准日：1900年1月1日 = 甲戌日（序号10）
const baseDayIndex = 10;
const baseDate = new Date(1900, 0, 1);

// 计算某日的干支序号
const diffDays = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
const currentDayIndex = (baseDayIndex + diffDays) % 60;

// 检查是否匹配目标干支
if (currentDayIndex === targetDayIndex) {
  // 找到匹配的日期
}
```

---

## 🎉 v1.1.0 - MongoDB 自动管理功能

### 📅 更新日期
2024年

### ✨ 新功能

#### 1. MongoDB Docker 容器自动管理
在**本地开发模式**下，启动脚本现在会自动管理 MongoDB：

- ✅ **自动检测容器** - 检查 `destiny-mongo` 容器是否存在
- ✅ **自动创建容器** - 如果不存在则自动创建并启动
- ✅ **自动启动容器** - 如果容器存在但未运行则自动启动
- ✅ **智能跳过** - 如果容器已运行则直接使用

#### 2. 环境变量自动配置
- ✅ 自动检查 `backend/.env` 文件
- ✅ 如果不存在，自动从 `.env.example` 复制
- ✅ 如果 `.env.example` 也不存在，创建默认配置

#### 3. 完善的提示信息
启动时显示完整的 MongoDB 信息：
```
💾 MongoDB 信息：
   连接地址: mongodb://localhost:27017/destiny-analysis
   容器名称: destiny-mongo
   数据卷: destiny-mongo-data

💡 提示：
   - 查看容器日志: docker logs destiny-mongo
   - 停止容器: docker stop destiny-mongo
   - 删除容器: docker rm destiny-mongo
   - 删除数据: docker volume rm destiny-mongo-data
```

### 📝 更新的文件

#### 启动脚本
- **start.bat** (Windows)
  - 添加 MongoDB 容器检测和创建逻辑
  - 添加环境变量自动配置
  - 增强错误处理

- **start.sh** (Linux/Mac)
  - 添加 MongoDB 容器检测和创建逻辑
  - 添加环境变量自动配置
  - 增强错误处理

#### 文档
- **快速开始.md**
  - 更新本地开发模式说明
  - 简化启动步骤
  - 移除手动配置步骤

- **README.md**
  - 更新本地开发说明
  - 添加 MongoDB 管理链接
  - 补充常见问题

- **MongoDB使用说明.md** (新增)
  - MongoDB 容器管理详细说明
  - 数据备份和恢复方法
  - 故障排除指南
  - 性能优化建议

- **更新日志.md** (本文件)
  - 记录版本更新历史

### 🎯 使用方法

#### Windows 用户
```bash
# 双击运行
start.bat

# 或命令行运行
.\start.bat

# 选择选项 2（本地开发模式）
```

#### Mac/Linux 用户
```bash
# 添加执行权限（首次）
chmod +x start.sh

# 运行
./start.sh

# 选择选项 2（本地开发模式）
```

### 🔧 技术细节

#### MongoDB 容器配置
```bash
容器名称：destiny-mongo
镜像版本：mongo:7.0
端口映射：27017:27017
数据卷：destiny-mongo-data
连接串：mongodb://localhost:27017/destiny-analysis
```

#### 检测逻辑
1. 使用 `docker ps -a` 检查所有容器
2. 查找名为 `destiny-mongo` 的容器
3. 如果不存在，执行创建命令
4. 如果存在但未运行，执行启动命令
5. 如果已运行，跳过并继续

#### 错误处理
- ❌ 容器创建失败 → 退出并提示错误
- ❌ 容器启动失败 → 退出并提示错误
- ❌ Docker 未安装 → 提示安装 Docker Desktop
- ❌ Node.js 未安装 → 提示安装 Node.js 18+

### 📊 对比

#### 旧方式（v1.0.0）
```bash
# 需要手动操作
1. 手动启动 MongoDB
   docker run -d -p 27017:27017 --name mongo mongo:7.0

2. 手动配置 .env 文件
   创建 backend/.env
   复制配置内容

3. 安装依赖
   npm run install-all

4. 启动服务
   npm run dev
```

#### 新方式（v1.1.0）
```bash
# 一键完成所有操作
1. 运行启动脚本
   start.bat（Windows）或 ./start.sh（Mac/Linux）

2. 选择选项 2

3. 等待自动完成 ✅
   - MongoDB 容器自动启动
   - 环境变量自动配置
   - 依赖自动安装
   - 服务自动启动
```

### 💡 优势

1. **更简单** - 从 4 步减少到 2 步
2. **更快速** - 无需手动输入命令
3. **更可靠** - 自动检测和错误处理
4. **更友好** - 清晰的进度提示

### 🔄 迁移指南

如果您之前使用 v1.0.0 版本：

#### 可选操作（清理旧容器）
```bash
# 停止并删除旧的 mongo 容器
docker stop mongo
docker rm mongo

# 新版本会创建 destiny-mongo 容器
```

#### 直接使用新版本
```bash
# 无需任何迁移，直接使用启动脚本即可
start.bat  # 或 ./start.sh
```

### 📦 版本兼容性

- ✅ **向后兼容** - 旧的手动方式仍然可用
- ✅ **数据迁移** - 使用数据卷，数据不会丢失
- ✅ **配置兼容** - 环境变量配置保持不变

### 🐛 已知问题

无重大已知问题。如遇到问题请查看：
- [快速开始.md](./快速开始.md) - 故障排除
- [MongoDB使用说明.md](./MongoDB使用说明.md) - MongoDB 相关问题

### 🎓 学习价值

这次更新展示了：
1. **Shell 脚本编程** - Windows Batch 和 Bash
2. **Docker 容器管理** - 检测、创建、启动
3. **自动化部署** - 减少手动操作
4. **错误处理** - 优雅的错误处理流程
5. **用户体验** - 提升开发者体验

---

## 📜 历史版本

### v1.0.0 - 初始版本

#### 发布日期
2024年

#### 功能列表
- ✅ 完整的全栈架构
- ✅ 用户认证系统
- ✅ 八字计算引擎
- ✅ 前端 React 应用
- ✅ Docker Compose 部署
- ✅ 完整文档

#### 局限性
- ❌ 需要手动启动 MongoDB
- ❌ 需要手动配置环境变量
- ❌ 启动步骤较多

---

## 🔮 未来规划

### v1.2.0（计划中）
- [ ] 数据库自动备份功能
- [ ] 健康检查脚本
- [ ] 性能监控面板

### v2.0.0（规划中）
- [ ] 更多八字分析功能
- [ ] AI 命理解析助手
- [ ] 社区互动功能增强
- [ ] 移动端适配优化

---

## 📞 反馈

如果您有任何建议或发现问题：
1. 提交 Issue
2. 查看文档
3. 联系维护者

---

**感谢使用！祝您开发愉快！** 🎉

---

*最后更新：2024年*
*当前版本：v1.1.0*

